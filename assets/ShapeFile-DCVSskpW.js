import{c as E,d as V,g as L,i as D,D as J,n as P}from"./index-DwHrM92q.js";import{r as W,C as F}from"./Coords-C-Mhj230.js";import{c as T}from"./turf.es-BzqbG201.js";import{r as R,G as _}from"./geo-utils-BVDB_NWh.js";import{Y as N}from"./index-DFKcNkqO.js";import{M as B,i as j}from"./ModalIdColumnPicker-DXdspCGE.js";import{d as H,g as q,H as G}from"./HTTPFileSystem-BSjE8vRF.js";import{D as U}from"./DeckMapComponent-Avq4Bsr0.js";import{M as C}from"./ColorsAndWidths-DwTESoC5.js";import{V as K}from"./VizConfigurator-BK-ywAyJ.js";import{L as X}from"./LegendBox-CuvKH7QY.js";import{Z as Y}from"./ZoomButtons-DjpMs2ei.js";import{D as Q}from"./DrawingTool-B_aVtBzC.js";import{c as Z,D as tt}from"./DashboardDataManager-DmaI1p62.js";import{L as et}from"./LegendStore-CGgeb9zL.js";import{B as z}from"./BackgroundLayers-zu7E2ECn.js";import"./papaparse.min-DLIg98vj.js";import"./fxp-DjoqftHf.js";import"./LineOffsetLayer-BT_eFkEQ.js";import"./line-layer-BJTc6V-8.js";import"./layer-T9N9JmIf.js";import"./GeojsonOffsetLayer-Bnd_y6YX.js";import"./PathOffsetLayer-apVO-iJh.js";import"./geojson-layer-5Wtw9r1a.js";import"./mapbox-overlay-HS93bZkL.js";import"./data-filter-extension-BJBYmUft.js";import"./layer-extension-LbH36Bf-.js";import"./cubehelix-BzW-tINw.js";import"./threshold-CrWFx_nu.js";import"./index-_doEQLKC.js";import"./rainbow-DNS2KC2A.js";import"./lodash-D2jY1fif.js";import"./FileSelector-BamV61Vr.js";import"./index-DlIS7h_x.js";import"./group-hI8ly2Wr.js";import"./sequential-pySAYR1V.js";import"./pow-RbZoge3Z.js";import"./precisionRound-CRsIqO1V.js";var $,I;function st(){if(I)return $;I=1;function e(i){return i>=55296&&i<=56319}function t(i){return i>=56320&&i<=57343}return $=function(s,a,o){if(typeof a!="string")throw new Error("Input must be string");for(var r=a.length,n=0,l,h,d=0;d<r;d+=1){if(l=a.charCodeAt(d),h=a[d],e(l)&&t(a.charCodeAt(d+1))&&(d+=1,h+=a[d]),n+=s(h),n===o)return a.slice(0,d+1);if(n>o)return a.slice(0,d-h.length+1)}return a},$}var k,M;function it(){if(M)return k;M=1;function e(i){return i>=55296&&i<=56319}function t(i){return i>=56320&&i<=57343}return k=function(s){if(typeof s!="string")throw new Error("Input must be string");for(var a=s.length,o=0,r=null,n=null,l=0;l<a;l++)r=s.charCodeAt(l),t(r)?n!=null&&e(n)?o+=1:o+=3:r<=127?o+=1:r>=128&&r<=2047?o+=2:r>=2048&&r<=65535&&(o+=3),n=r;return o},k}var x,A;function at(){if(A)return x;A=1;var e=st(),t=it();return x=e.bind(null,t),x}var S,O;function ot(){if(O)return S;O=1;var e=at(),t=/[\/\?<>\\:\*\|"]/g,i=/[\x00-\x1f\x80-\x9f]/g,s=/^\.+$/,a=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,o=/[\. ]+$/;function r(n,l){if(typeof n!="string")throw new Error("Input must be string");var h=n.replace(t,l).replace(i,l).replace(s,l).replace(a,l).replace(o,l);return e(h,255)}return S=function(n,l){var h=l&&l.replacement||"",d=r(n,h);return h===""?d:r(d,"")},S}var nt=ot();const rt=E(nt),lt="/simwrapper/assets/icon-blue-ramp-D1d4h-6x.png",dt=V({name:"ShapeFilePlugin",components:{LegendBox:X,GeojsonLayer:U,ModalIdColumnPicker:B,VizConfigurator:K,ZoomButtons:Y,DrawingTool:Q},props:{root:{type:String,required:!0},subfolder:{type:String,required:!0},datamanager:{type:Object},configFromDashboard:{type:Object},yamlConfig:String,thumbnail:Boolean},data(){return{icons:{blueramp:lt},opacitySlider:50,avroNetwork:null,isAtlantis:!1,isAreaMode:!1,isAvroFile:!1,isDraggingDivider:0,isDragHappening:!1,isLoaded:!1,dragStartWidth:200,legendSectionWidth:200,boundaries:[],centroids:[],cbDatasetJoined:void 0,legendStore:new et,chosenNewFilterColumn:"",boundaryDataTable:{},dataFillColors:"#888",dataLineColors:"",dataLineWidths:1,dataPointRadii:5,dataFillHeights:0,dataCalculatedValues:null,dataNormalizedValues:null,constantLineWidth:null,dataCalculatedValueLabel:"",globalStore:L,globalState:L.state,layerId:Math.floor(1e12*Math.random()),dbClearTooltip:{},wantToClearTooltip:!1,activeColumn:"",useCircles:!1,sliderOpacity:100,maxValue:1e3,expColors:!1,isRGBA:!1,statusText:"Loading...",filters:{},needsInitialMapExtent:!0,datasetJoinColumn:"",featureJoinColumn:"",triggerScreenshot:0,redraw:0,datasetKeyToFilename:{},datasetJoinSelector:{},showJoiner:!1,showLegend:!1,myDataManager:this.datamanager||new tt(this.root,this.subfolder),config:{},currentUIFilterDefinitions:{},currentUIFillColorDefinitions:{},currentUILineColorDefinitions:{},filterDefinitions:[],isEmbedded:!1,resizer:null,boundaryFilters:new Float32Array(0),boundaryJoinLookups:{},datasetValuesColumn:"",tooltipHtml:"",tooltipIsFixed:!1,tooltipDesiredColumns:[],showTooltipConfigurator:!1,highlightedLinkIndex:-1,bgLayers:{},backgroundLayers:null,initialView:null,vizDetails:{title:"",description:"",datasets:{},useSlider:!1,showDifferences:!1,shpFile:"",dbfFile:"",network:"",geojsonFile:"",projection:"",widthFactor:null,sum:!1,filters:[],shapes:"",zoom:null,center:null,pitch:null,bearing:null,mapIsIndependent:!1,display:{fill:{},fillHeight:{},color:{},width:{},lineColor:{},lineWidth:{},radius:{}},tooltip:[],backgroundLayers:{}},datasets:{},loadProgress:0,loadSteps:0,totalLoadSteps:6}},computed:{fileApi(){return new G(this.fileSystem,L)},fileSystem(){const e=this.$store.state.svnProjects.filter(t=>t.slug===this.root);if(e.length===0)throw console.log("no such project"),Error;return e[0]},configuratorSections(){return this.isAreaMode?["fill-color","fill-height","line-color","line-width","circle-radius","layers","filters"]:["line-color","line-width","layers","filters"]},datasetChoices(){return Object.keys(this.datasets)},generatedExportFilename(){let e=rt(this.yamlConfig??"");return e=e.replaceAll(" ","-"),e.startsWith("viz-map-")||(e="viz-map-"+e),!e.endsWith(".yml")&&!e.endsWith(".yaml")&&(e=e+".yaml"),e}},watch:{},methods:{setDesiredTooltipsNone(){this.tooltipDesiredColumns.forEach(e=>e.enabled=!1)},setDesiredTooltipsAll(){this.tooltipDesiredColumns.forEach(e=>e.enabled=!0)},setupTooltipDesiredColumns(){try{return Object.keys(this.boundaryDataTable).map(t=>({col:t,enabled:!0}))}catch{return[]}},incrementLoadProgress(){this.loadSteps+=1,this.loadProgress=100*this.loadSteps/this.totalLoadSteps},dividerDragStart(e){this.isDraggingDivider=e.clientX,this.dragStartWidth=this.legendSectionWidth},dividerDragEnd(e){this.isDraggingDivider=0},dividerDragging(e){if(!this.isDraggingDivider)return;const t=this.isDraggingDivider-e.clientX;this.legendSectionWidth=Math.max(0,this.dragStartWidth+t)},takeScreenshot(){this.triggerScreenshot++},setEmbeddedMode(){"embed"in this.$route.query&&(console.log("EMBEDDED MODE"),this.isEmbedded=!0,this.$store.commit("setShowLeftBar",!1),this.$store.commit("setFullWidth",!0))},columnsInDataset(e){const t=this.datasets[e];return Object.keys(t)},filterShapesNow(){const e=this.filterDefinitions.filter(i=>i.dataset==="shapes");if(this.boundaryFilters=new Float32Array(this.boundaries.length),!e.length)return;const t=/^(<|>)/;for(const i of e){let s=i.value,a="";if(s=="@categorical")a="@categorical",s="";else if(t.test(s))s.startsWith("<=")?(a="<=",s=parseFloat(s.substring(2).trim())):s.startsWith(">=")?(a=">=",s=parseFloat(s.substring(2).trim())):s.startsWith("<")?(a="<",s=parseFloat(s.substring(1).trim())):s.startsWith(">")&&(a=">",s=parseFloat(s.substring(1).trim()));else if(typeof s=="string")if(s.indexOf(",")>-1)s=s.split(",").map(n=>n.trim()).map(n=>Number.isNaN(parseFloat(n))?n:parseFloat(n));else{const n=parseFloat(s);Number.isNaN(n)||(s=n)}Array.isArray(s)||(s=[s]);const o={conditional:a,invert:i.invert||!1,values:s},r=this.boundaryDataTable[i.column].values;for(let n=0;n<this.boundaries.length;n++)Z(o,r[n])||(this.boundaryFilters[n]=-1)}},truncateFractionalPart(e,t){if(typeof e!="number")return e;let i=""+e;return i.includes(".")&&i.indexOf(".")===i.lastIndexOf(".")&&/\d$/.test(i)?i.substring(0,1+t+i.lastIndexOf(".")):e},async handleClickEvent(e){if(e.index!=-1){let t=e?.object?.feature_idx||-1;this.cbTooltip(t,e,!0),this.tooltipIsFixed=!0,this.highlightedLinkIndex=e.index}else this.tooltipIsFixed=!1,this.highlightedLinkIndex=-1,this.tooltipHtml=""},clearTooltip(){this.wantToClearTooltip&&this.highlightedLinkIndex==-1&&(this.tooltipHtml="")},cbTooltip(e,t,i=!1){if(this.tooltipIsFixed&&!i)return;if(t===null||!this.boundaries[e]?.properties){this.wantToClearTooltip=!0,this.dbClearTooltip();return}this.wantToClearTooltip=!1;const s=4;let a=[];if(!this.vizDetails.tooltip?.length){if(this.dataNormalizedValues){const u=this.dataCalculatedValueLabel||"Normalized Value";let m=this.truncateFractionalPart(this.dataNormalizedValues[e],s);a.push(`<tr><td style="text-align: right; padding-right: 0.5rem;">${u}</td><td><b>${m}</b></td></tr>`)}if(this.dataCalculatedValues){let u=this.dataCalculatedValueLabel||"Value";const m=this.dataNormalizedValues?u.substring(0,u.lastIndexOf("/")):u;let b=this.truncateFractionalPart(this.dataCalculatedValues[e],s);this.dataCalculatedValueLabel.startsWith("%")&&(b=`${b} %`),a.push(`<tr><td style="text-align: right; padding-right: 0.5rem;">${m}</td><td><b>${b}</b></td></tr>
            <tr><td>&nbsp;</td></tr>`)}}let o="";const r=Object.entries(this.boundaries[e].properties);for(const[u,m]of r){if(m===null)continue;let b=this.truncateFractionalPart(m,s);o+=`<tr><td style="text-align: right; padding-right: 0.5rem;">${u}</td><td><b>${b}</b></td></tr>`}o&&a.push(o);let n;this.tooltipDesiredColumns.length?n=this.tooltipDesiredColumns.filter(u=>u.enabled).map(u=>u.col):n=Object.keys(this.boundaryDataTable);const l=new Set(["id","from","to","source","dest","nodeCoordinates","nodeId"]);if(n=n.filter(u=>!l.has(u)),this.vizDetails.tooltip?.length){const u=this.vizDetails.tooltip[0].indexOf(":")>-1?":":".";n=this.vizDetails.tooltip.map(m=>m.substring(m.indexOf(u)+1))}const h=["id","from","to",...n];let d="";if(h.forEach(u=>{if(this.boundaryDataTable[u]){let m=this.boundaryDataTable[u].values[e];if(m==null)return;typeof m=="number"&&(m=this.truncateFractionalPart(m,s)),d+=`<tr><td style="text-align: right; padding-right: 0.5rem;">${u}</td><td><b>${m}</b></td></tr>`}}),d&&a.push(d),!a.length){this.tooltipHtml="";return}const g=`<table>${a.join("")}</table>`;this.tooltipHtml=g},filterShapesNowOriginal(){const e=this.filterDefinitions.filter(t=>t.dataset==="shapes");if(this.boundaryFilters=new Float32Array(this.boundaries.length),!!e.length)for(let t=0;t<this.boundaries.length;t++)for(const i of e)!this.checkIsFiltered(t,i)&&(this.boundaryFilters[t]=-1)},checkIsFiltered(e,t){const s=(t.dataset=="shapes"?this.boundaryDataTable:this.datasets[t.dataset])[t.column].values[e];let a=!1,o=t.value;return typeof o=="string"&&o.indexOf(",")>-1&&(o=o.split(",").map(r=>r.trim()).map(r=>isNaN(parseFloat(r))?r:parseFloat(r))),Array.isArray(o)?a=o.indexOf(s)>-1:a=o==s,t.invert&&(a=!a),a},parseFilterDefinitions(e){if(!e)return[];const t=[];let i;Array.isArray(e)?i=e.map(s=>Object.entries(s)[0]):i=Object.entries(e);for(const s of i){const[a,o]=s,[r,n]=a.split("."),l={dataset:r,value:o,column:n.endsWith("!")?n.substring(0,n.length-1):n,invert:n.endsWith("!")};t.push(l)}return t},honorQueryParameters(){this.$route.query.show=="dots"&&(this.useCircles=!0)},setupQueryFilters(){const e=Object.keys(this.datasets);if(e.length!==2)return;const t=e[1],i=this.datasets[t],s=Object.keys(i),a=Object.keys(this.$route.query).filter(o=>s.indexOf(o)>-1);for(const o of a){this.filters[o]||(console.log("CREATING category filter:",o),this.handleUserCreatedNewFilter(`${t}:${o}`));const r=""+this.$route.query[o];r&&(this.filters[o].active=r.split(",")),this.myDataManager.setFilter({dataset:this.datasetKeyToFilename[t],column:o,value:this.filters[o].active}),this.activateFiltersForDataset(t)}},convertCommasToArray(e){return e===void 0?[]:(Array.isArray(e)||(e.indexOf(",")>-1?e=e.split(",").map(t=>t.trim()):e=[e.trim()]),e)},async getVizDetails(){const e={datasets:{},display:{fill:{}}};if(this.configFromDashboard)this.config=JSON.parse(JSON.stringify(this.configFromDashboard)),this.vizDetails=Object.assign({},e,this.configFromDashboard);else{const i=(this.yamlConfig??"").toLocaleLowerCase();if(i?.endsWith("yaml")||i?.endsWith("yml")){const s=await this.loadYamlConfig();this.config=s,this.vizDetails=Object.assign({},e,s)}if(/(\.xml)(|\.gz)$/.test(i)||/(\.geojson)(|\.gz)$/.test(i)||/\.shp$/.test(i)||/\.gpkg$/.test(i)||/network.*\.avro$/.test(i)||/.gmns.zip$/.test(i)||/.gmns$/.test(i)){let s=this.yamlConfig;i.endsWith("shp")&&(s=`Shapefile: ${this.yamlConfig}`),i.indexOf(".gmns")>-1&&(s=`GMNS Network: ${this.yamlConfig}`),this.vizDetails=Object.assign({},e,this.vizDetails,{title:s,description:this.subfolder,shapes:this.yamlConfig}),this.config=JSON.parse(JSON.stringify(this.vizDetails))}}if(this.vizDetails.backgroundLayers||(this.vizDetails.backgroundLayers={}),typeof this.vizDetails.tooltip=="string"){const i=this.vizDetails.tooltip.split(",").map(s=>s.trim());this.vizDetails.tooltip=i,this.config.tooltip=i}const t=this.vizDetails.title||"Map";this.$emit("title",t)},buildOldJoinLookups(){const e={};for(const t of Object.keys(this.vizDetails.datasets||[])){const i=this.vizDetails.datasets[t].join;if(!i)continue;const s=i.indexOf(":");if(e[t]=i.substring(s+1),typeof this.vizDetails.shapes=="string"){const a=s>-1?i.substring(0,s):i;this.vizDetails.shapes={file:this.vizDetails.shapes,join:a}}}for(const t of Object.keys(this.vizDetails.display||[])){const s=this.vizDetails.display[t];(s.dataset||s.diff)&&!s.join&&(s.join=e[s.dataset])}},getFileSystem(e){const t=this.$store.state.svnProjects.filter(i=>i.slug===e);if(t.length===0)throw console.log("no such project"),Error;return t[0]},async loadYamlConfig(){const e=this.yamlConfig??"",t=e.indexOf("/")>-1?e:this.subfolder+"/"+e;try{const s=await this.fileApi.getFileText(t);return N.parse(s)}catch(s){const a=""+s;a.startsWith("YAMLSemantic")&&this.$emit("error",`${t}: ${a}`),console.log(`${t} not found, trying config folders`)}const{vizes:i}=await this.fileApi.findAllYamlConfigs(this.subfolder);if(i[e])try{const s=await this.fileApi.getFileText(i[e]);return N.parse(s)}catch{console.error(`Also failed to load ${i[e]}`)}this.$emit("error","Could not load YAML: "+t)},changeConfiguration(e){try{e.fill&&(this.vizDetails.display.fill=e.fill,this.handleNewFillColor(e.fill)),e.fillHeight&&(this.vizDetails.display.fillHeight=e.fillHeight,this.handleNewFillHeight(e.fillHeight)),e.lineColor&&(this.vizDetails.display.lineColor=e.lineColor,this.handleNewLineColor(e.lineColor)),e.lineWidth&&(this.vizDetails.display.lineWidth=e.lineWidth,this.handleNewLineWidth(e.lineWidth),this.currentUILineColorDefinitions&&this.handleNewLineColor(this.currentUILineColorDefinitions)),e.radius&&(this.vizDetails.display.radius=e.radius,this.handleNewRadius(e.radius)),e.dataset&&this.handleNewDataset(e.dataset),e.layers&&this.handleNewLayers(e.layers),e.filters&&this.handleNewFilters(e.filters)}catch(t){this.$emit("error",""+t)}},handleNewLayers(e){const t={};for(const i of e){const{title:s,...a}=i;t[s]=a}this.vizDetails.backgroundLayers=t;try{this.backgroundLayers=new z({vizDetails:this.vizDetails,fileApi:this.fileApi,subfolder:this.subfolder}),this.backgroundLayers.initialLoad(),this.bgLayers={...this.bgLayers}}catch(i){console.error("Error handling layers, check filenames and parameters: "+i)}},generateUniqueDatasetKeyFromFilename(e){if(!(e in this.vizDetails.datasets))return e;console.log(e,"not unique");for(let t=2;t<100;t++){let i=`${e}_${t}`;if(!(i in this.vizDetails.datasets))return i}return`${e}__${Math.floor(100+1e5*Math.random())}`},async handleNewDataset(e){let{key:t,dataTable:i,filename:s}=e;const o=this.generateUniqueDatasetKeyFromFilename(t),r=s||o;if(console.log("HANDLE NEW DATASET:",o,r),this.featureJoinColumn||(this.featureJoinColumn=await this.figureOutFeatureIdColumn()),console.log("---featureIDColumn",this.featureJoinColumn),!this.boundaryDataTable[this.featureJoinColumn])throw Error(`Geodata does not have property ${this.featureJoinColumn}`);this.myDataManager.setPreloadedDataset({key:this.datasetKeyToFilename[o],dataTable:i}),this.myDataManager.addFilterListener({dataset:this.datasetKeyToFilename[o],subfolder:this.subfolder},this.processFiltersNow),this.vizDetails.datasets[o]={file:r},this.vizDetails=Object.assign({},this.vizDetails),this.datasets[o]=i,this.datasets=Object.assign({},this.datasets)},setupJoin(e){const{dataTable:t,datasetId:i,dataJoinColumn:s}=e;if(!s||`@@${s}`in t)return;if(!this.boundaryDataTable[this.featureJoinColumn])throw Error(`Geodata does not have property ${this.featureJoinColumn}`);if(!t[s])throw Error(`Dataset ${i} does not have column ${s}`);const a={type:D.LOOKUP,values:[],name:`@@${s}`},o=t[s].values,r=this.getBoundaryOffsetLookup(this.featureJoinColumn);for(let n=0;n<o.length;n++){const l=r[o[n]];a.values[n]=l}t[`@@${s}`]=a,this.myDataManager.setPreloadedDataset({key:this.datasetKeyToFilename[i],dataTable:t}),this.vizDetails.datasets[i]={file:this.datasetKeyToFilename[i],join:this.featureJoinColumn===s?this.featureJoinColumn:`${this.featureJoinColumn}:${s}`},this.myDataManager.addFilterListener({dataset:this.datasetKeyToFilename[i],subfolder:this.subfolder},this.processFiltersNow),this.prepareTooltipData(e),this.datasets[i]=t},prepareTooltipData(e){const{dataTable:t,datasetId:i,dataJoinColumn:s}=e;let a=":",o=this.vizDetails.tooltip||[];if(o instanceof String&&(o=o.split(",").map(h=>h.trim())),o.length&&(a=o[0].indexOf(":")>-1?":":"."),!o.length){const h=Object.values(this.vizDetails.display);for(const d of h)d.columnName&&d.dataset===i&&o.push(`${i}${a}${d.columnName}`)}const r=o.filter(h=>h.substring(0,h.indexOf(a)).startsWith(i)).map(h=>({id:h,column:h.substring(1+h.indexOf(a))}));if(!r.length)return;const n=t[s].values,l=this.getBoundaryOffsetLookup(this.featureJoinColumn);for(const h of r){if(!t[h.column]){this.$emit("error",`Tooltip references "${h.id}" but that column doesn't exist`);continue}for(let d=0;d<n.length;d++){const c=l[n[d]],g=this.boundaries[c],u=t[h.column].values[d];g&&(g.properties[h.id]=u)}}},getBoundaryOffsetLookup(e){if(this.boundaryJoinLookups[e])return this.boundaryJoinLookups[e];try{this.statusText="Joining datasets...",this.boundaryJoinLookups[e]={};const t=this.boundaryJoinLookups[e],i=this.boundaryDataTable[e].values;for(let s=0;s<this.boundaries.length;s++)t[i[s]]=s;return this.statusText="",t}catch{return console.warn("waahaa"),{}}},removeAnyOldFilters(e){const t=new Set(Object.keys(this.currentUIFilterDefinitions).filter(s=>!s.startsWith("shapes.")));new Set(Object.keys(e).filter(s=>!s.startsWith("shapes."))).forEach(s=>t.delete(s));for(const s of t){console.log("REMOVING",s);const a=s.indexOf("."),o=s.slice(0,a),r=s.slice(a+1);if(this.myDataManager.setFilter({dataset:this.datasetKeyToFilename[o],column:r,value:[]}),r in this.filters){const n=Object.assign({},this.$route.query);delete n[r],this.$router.replace({query:n}),delete this.filters[r]}}},async handleNewFilters(e){this.removeAnyOldFilters(e),this.currentUIFilterDefinitions=e;const t=this.parseFilterDefinitions(e);this.filterDefinitions=t,this.filterShapesNow(),Object.keys(this.datasets).forEach(async(i,s)=>{s!==0&&(await this.activateFiltersForDataset(i),this.processFiltersNow(i))})},handleColorDiffMode(e,t){if(!t.diffDatasets)return;const i=t.columnName,s=t.join||"",a=t.diffDatasets[0]||"",o=this.datasets[a],r=t.diffDatasets[1]||"",n=this.datasets[r],l=!!t.relative;if(o&&n){this.setupJoin({datasetId:a,dataTable:o,dataJoinColumn:s}),this.setupJoin({datasetId:r,dataTable:n,dataJoinColumn:s});const h=o[`@@${s}`],d=n[`@@${s}`],c=o[i],g=n[i];if(!c)throw Error(`Dataset ${a} does not contain column "${i}"`);if(!g)throw Error(`Dataset ${r} does not contain column "${i}"`);let u,m;if(t.normalize){const[f,p]=t.normalize.split(":");if(!this.datasets[f]||!this.datasets[f][p])throw Error(`${f} does not contain column "${p}"`);this.dataCalculatedValueLabel+=`/ ${p}`,u=this.datasets[f][p],this.datasetChoices[0]!==f&&(this.setupJoin({datasetId:f,dataTable:this.datasets[f],dataJoinColumn:s}),m=this.datasets[f][`@@${s}`])}const b={ramp:t.colorRamp?.ramp||"Viridis",style:t.colorRamp?.style||0,reverse:t.colorRamp?.reverse||!1,steps:t.colorRamp?.steps||9,breakpoints:t.colorRamp?.breakpoints},{rgbArray:v,legend:w,calculatedValues:y}=C.getColorsForDataColumn({numFeatures:this.boundaries.length,data:c,data2:g,lookup:h,lookup2:d,normalColumn:u,normalLookup:m,options:{colorRamp:b,fixedColors:t.fixedColors},filter:this.boundaryFilters,relative:l});if(!v)return;e==="fill"?this.dataFillColors=v:this.dataLineColors=v,this.dataCalculatedValues=y,this.dataCalculatedValueLabel=`${l?"% ":""}Diff: ${i}`,this.showLegend=!0,this.legendStore.setLegendSection({section:e==="fill"?"FillColor":"Line Color",column:c.name,values:w,diff:!0,relative:l,normalColumn:u?u.name:""})}},paintColorsWithFilter(e,t){const i=e==="fill"?this.currentUIFillColorDefinitions:this.currentUILineColorDefinitions,s=i.columnName,a=i.join==="@count"?t[`@@${s}`]:t[`@@${i.join}`];let o;if(i.normalize){const d=i.normalize.split(":");this.dataCalculatedValueLabel=s+"/"+d[1];const c=i.dataset;if(!this.datasets[d[0]]||!this.datasets[d[0]][d[1]])throw Error(`Dataset ${c} does not contain column "${s}"`);o=t[d[1]]}const r={numFeatures:this.boundaries.length,data:t[s],lookup:a,normalColumn:o,filter:this.boundaryFilters,options:i,join:i.join},{rgbArray:n,legend:l,calculatedValues:h}=C.getColorsForDataColumn(r);n&&(e==="fill"?this.dataFillColors=n:this.dataLineColors=n,this.dataCalculatedValues=h,this.showLegend=!0,this.legendStore.setLegendSection({section:e==="fill"?"FillColor":"Line Color",column:s,values:l}))},handleNewFillColor(e){const t="columnName"in e,i=!t;if(t){const f=e?.dataset,{filteredRows:p}=this.myDataManager.getFilteredDataset({dataset:`${f}`||""});if(p&&p.length){this.currentUIFillColorDefinitions=e,this.processFiltersNow(f);return}}if(i){this.paintColorsWithFilter("fill",e);return}const s=e;this.currentUIFillColorDefinitions=s;const a=s.columnName;if(s.diffDatasets){this.handleColorDiffMode("fill",s);return}if(!a){this.dataFillColors=s.fixedColors[0],this.dataCalculatedValueLabel="",this.legendStore.clear("FillColor");return}const o=s.dataset||"",r=this.datasets[o];if(this.dataCalculatedValueLabel="",!r){console.warn("color: no selected dataset yet, maybe still loading");return}const n=r[a];if(!n)throw Error(`Dataset ${o} does not contain column "${a}"`);this.dataCalculatedValueLabel=a??"",this.$emit("error","");let l="";if(s.join&&s.join!=="@count")l=s.join;else if(s.join==="@count")l=a;else if(this.datasetChoices.length>1){const f=this.datasetChoices[0];o!==f&&(console.warn("No join; lets hope user just wants to display data in boundary file"),this.$emit("error",`Specify the "Join by" column to link ${o} dataset values correctly!`))}this.setupJoin({datasetId:o,dataTable:r,dataJoinColumn:l});const h=r[`@@${l}`];let d,c;if(s.normalize){const[f,p]=s.normalize.split(":");if(!this.datasets[f]||!this.datasets[f][p])throw Error(`${f} does not contain column "${p}"`);this.dataCalculatedValueLabel+=`/ ${p}`,d=this.datasets[f][p],this.datasetChoices[0]!==f&&this.setupJoin({datasetId:f,dataTable:this.datasets[f],dataJoinColumn:l}),c=this.datasets[f][`@@${l}`]}const g={ramp:s.colorRamp?.ramp||"Viridis",style:s.colorRamp?.style||0,reverse:s.colorRamp?.reverse||!1,steps:s.colorRamp?.steps||9,breakpoints:s.colorRamp?.breakpoints||void 0};let u;if(s.transparency){const[f,p]=s.transparency.split("/");if(u=this.datasets[f][p],!u)throw Error(`Dataset ${f} does not contain column "${p}"`)}const m=C.getColorsForDataColumn({numFeatures:this.boundaries.length,data:n,transparency:u,normalColumn:d,normalLookup:c,lookup:h,filter:this.boundaryFilters,options:{colorRamp:g,fixedColors:s.fixedColors},join:s.join}),{rgbArray:b,legend:v,calculatedValues:w}=m,y=m.isRGBA||!1;b&&(this.dataFillColors=b,this.dataCalculatedValues=w,this.dataNormalizedValues=null,this.isRGBA=y,this.showLegend=!0,this.legendStore.setLegendSection({section:"FillColor",column:n.name,values:v,normalColumn:d?d.name:""}))},handleNewLineColor(e){if(e===!1){this.dataLineColors="",this.legendStore.clear("Line Color");return}const t="columnName"in e,i=!t;if(t){const o=e?.dataset;if(o){const{filteredRows:r}=this.myDataManager.getFilteredDataset({dataset:`${o}`||""});if(r&&r.length){this.currentUILineColorDefinitions=e,this.processFiltersNow(o);return}}}const s=e;if(i&&s.columnName!=="@0"){this.paintColorsWithFilter("lineColor",e);return}this.currentUILineColorDefinitions=s;const a=s.columnName;if(s.diffDatasets){this.handleColorDiffMode("lineColor",s);return}else if(a==="@0"){this.dataLineColors=this.isAreaMode?"":"#4E7AA7",this.dataCalculatedValueLabel="",this.legendStore.clear("Line Color");return}else if(a){const o=s.dataset||"",r=this.datasets[o];if(this.dataCalculatedValueLabel="",!r){console.warn("color: no selected dataset yet, maybe still loading");return}const n=r[a];if(!n)throw Error(`Dataset ${o} does not contain column "${a}"`);this.dataCalculatedValueLabel=a??"",this.$emit("error","");let l="";if(s.join&&s.join!=="@count")l=s.join;else if(s.join==="@count")l=a;else if(this.datasetChoices.length>1){const y=this.datasetChoices[0];o!==y&&(console.warn("No join; lets hope user just wants to display data in boundary file"),this.$emit("error",`Specify the "Join by" column to link ${o} dataset values correctly!`))}this.setupJoin({datasetId:o,dataTable:r,dataJoinColumn:l});const h=r[`@@${l}`];let d,c;if(s.normalize){const[y,f]=s.normalize.split(":");if(!this.datasets[y]||!this.datasets[y][f])throw Error(`${y} does not contain column "${f}"`);this.dataCalculatedValueLabel+=`/ ${f}`,d=this.datasets[y][f],this.datasetChoices[0]!==y&&(this.setupJoin({datasetId:y,dataTable:this.datasets[y],dataJoinColumn:l}),c=this.datasets[y][`@@${l}`])}const g={ramp:s.colorRamp?.ramp||"Viridis",style:s.colorRamp?.style||0,reverse:s.colorRamp?.reverse||!1,steps:s.colorRamp?.steps||9,breakpoints:s.colorRamp?.breakpoints},u=C.getColorsForDataColumn({numFeatures:this.boundaries.length,data:n,lookup:h,normalColumn:d,normalLookup:c,filter:this.boundaryFilters,options:{colorRamp:g,fixedColors:s.fixedColors},join:s.join}),{rgbArray:m,legend:b,calculatedValues:v,normalizedValues:w}=u;if(!m)return;if(this.dataLineColors=m,this.dataCalculatedValues=v,this.dataNormalizedValues=w||null,u.hasCategory&&this.constantLineWidth!==null){const y=this.constantLineWidth,f=new Float32Array(this.boundaries.length).fill(1);Object.keys(u.hasCategory).forEach(p=>{f[p]=y}),this.dataLineWidths=f}this.showLegend=!0,this.legendStore.setLegendSection({section:"Line Color",column:n.name,values:b,normalColumn:d?d.name:""}),this.showLegend=!0}else{this.dataLineColors=s.fixedColors[0],this.dataCalculatedValueLabel="",this.legendStore.clear("Line Color");return}},handleNewLineWidth(e){const t=e.columnName||"";if(e.dataset&&/^@\d$/.test(e.dataset)){this.dataLineWidths=Number.parseInt(e.dataset.substring(1)),this.constantLineWidth=this.dataLineWidths,this.legendStore.clear("Line Width");return}else this.constantLineWidth=null;if(e.scaleFactor&&isNaN(e.scaleFactor)){this.dataLineWidths=1,this.legendStore.clear("Line Width");return}if(e.diffDatasets){const i=e.join||"",s=e.diffDatasets[0]||"",a=this.datasets[s],o=e.diffDatasets[1]||"",r=this.datasets[o];if(a&&r){this.setupJoin({datasetId:s,dataTable:a,dataJoinColumn:i}),this.setupJoin({datasetId:o,dataTable:r,dataJoinColumn:i});const n=a[`@@${i}`],l=r[`@@${i}`],h=a[t],d=r[t];if(!h)throw Error(`Dataset ${s} does not contain column "${t}"`);if(!d)throw Error(`Dataset ${o} does not contain column "${t}"`);const{array:c,legend:g,calculatedValues:u}=C.getWidthsForDataColumn({numFeatures:this.boundaries.length,data:h,data2:d,lookup:n,lookup2:l,options:e});this.dataLineWidths=c||0,this.dataCalculatedValues=u,this.dataCalculatedValueLabel="Diff: "+t,this.showLegend=!0,this.legendStore.setLegendSection({section:"Line Width",column:`${h.name} (Diff)`,values:g})}}else if(t){const i=e.dataset||"",s=this.datasets[i];if(s){const a=s[t];if(!a)throw Error(`Dataset ${i} does not contain column "${t}"`);this.$emit("error","");let o="";if(e.join&&e.join!=="@count")o=e.join;else if(e.join==="@count")o=t;else if(this.datasetChoices.length>1){const d=this.datasetChoices[0];i!==d&&(console.warn("No join; lets hope user just wants to display data in boundary file"),this.$emit("error",`Specify the "Join by" column to link ${i} dataset values correctly!`))}this.setupJoin({datasetId:i,dataTable:s,dataJoinColumn:o});const r=s[`@@${o}`],{array:n,legend:l,calculatedValues:h}=C.getWidthsForDataColumn({numFeatures:this.boundaries.length,data:a,lookup:r,join:e.join,options:e});this.dataLineWidths=n||0,this.dataCalculatedValues=h,this.dataCalculatedValueLabel=t,l.length?(this.showLegend=!0,this.legendStore.setLegendSection({section:"Line Width",column:a.name,values:l})):this.legendStore.clear("Line Width")}}else this.dataLineWidths=1,this.dataCalculatedValueLabel="",this.legendStore.clear("Line Width")},handleNewFillHeight(e){const t=e.columnName;if(t){const i=e.dataset||"",s=this.datasets[i];if(s){const a=s[t];if(!a)throw Error(`Dataset ${i} does not contain column "${t}"`);this.$emit("error","");let o="";if(e.join&&e.join!=="@count")o=e.join;else if(e.join==="@count")o=t;else if(this.datasetChoices.length>1){const c=this.datasetChoices[0];i!==c&&(console.warn("No join; lets hope user just wants to display data in boundary file"),this.$emit("error",`Specify the "Join by" column to link ${i} dataset values correctly!`))}this.setupJoin({datasetId:i,dataTable:s,dataJoinColumn:o});const r=s[`@@${o}`];let n;if(e.normalize){const c=e.normalize.split(":");if(!this.datasets[c[0]]||!this.datasets[c[0]][c[1]])throw Error(`Dataset ${i} does not contain column "${t}"`);n=this.datasets[c[0]][c[1]],this.dataCalculatedValueLabel=t+"/"+c[1]}const{heights:l,calculatedValues:h,normalizedValues:d}=C.getHeightsBasedOnNumericValues({length:this.boundaries.length,data:a,lookup:r,options:e,normalize:n,join:e.join});if(this.dataFillHeights=l,this.dataCalculatedValues=h,this.dataNormalizedValues=d||null,this.$store.state.viewState.pitch==0){const c=Object.assign({},this.$store.state.viewState,{pitch:30});this.$store.commit("setMapCamera",c)}}}else this.dataFillHeights=0,this.dataCalculatedValues=null,this.dataCalculatedValueLabel=""},handleNewRadius(e){const t=e.columnName;if(t){const i=e.dataset||"",s=this.datasets[i];if(!s)return;if(s){const a=s[t];if(!a)throw Error(`Dataset ${i} does not contain column "${t}"`);let o="";e.join&&e.join!=="@count"?o=e.join:e.join==="@count"?o=t:this.datasetChoices.length>1&&console.warn("No join; lets hope user just wants to display data in boundary file"),this.setupJoin({datasetId:i,dataTable:s,dataJoinColumn:o});const r=s[`@@${o}`],{radius:n,calculatedValues:l}=C.getRadiusForDataColumn({length:this.boundaries.length,data:a,lookup:r,join:o,options:e});this.dataPointRadii=n,this.dataCalculatedValues=l,this.dataCalculatedValueLabel=a.name}}else this.dataPointRadii=5},async handleMapClick(e){try{const{x:t,y:i,data:s}=e.points[0],a=this.config.groupBy,o=t}catch(t){console.error(t)}},async figureOutFeatureIdColumn(){if(this.featureJoinColumn)return this.featureJoinColumn;if(typeof this.vizDetails.shapes!="string"&&this.vizDetails.shapes.join)return this.isAvroFile&&this.vizDetails.shapes.join==="id"?"linkId":this.vizDetails.shapes.join;if(this.boundaries.length&&this.boundaries[0].id)return"id";if(typeof this.vizDetails.shapes!="string"&&this.vizDetails.shapes.join)return this.vizDetails.shapes.join;const e=this.datasets[Object.keys(this.datasets)[0]],t=Object.keys(e);if(t.length===1)return t[0];const i=await new Promise((s,a)=>{const o=new Set;this.boundaries[0].id&&o.add("id"),Object.keys(e).forEach(r=>o.add(r)),this.datasetJoinSelector={data1:{title:"Properties",columns:Array.from(o)}},this.showJoiner=!0,this.cbDatasetJoined=r=>{this.datasetJoinSelector={},this.showJoiner=!1,s(r)}});return i.length?i:"id"},async processFiltersNow(e){const{filteredRows:t}=this.myDataManager.getFilteredDataset({dataset:e||""}),i={};if(t){(t.length>0?Object.keys(t[0]):[]).forEach(r=>{const n={name:r,values:[],type:D.UNKNOWN};for(const l of t)n.values.push(l[r]);i[r]=n});const a=this.getBoundaryOffsetLookup(this.featureJoinColumn),o=new Float32Array(this.boundaryFilters.length);o.fill(1);for(const r of t){const n=r[this.featureJoinColumn],l=a[n];o[l]=0}for(let r=0;r<this.boundaryFilters.length;r++)o[r]&&(this.boundaryFilters[r]=-1)}try{this.currentUIFillColorDefinitions?.dataset&&this.handleNewFillColor(t?i:this.currentUIFillColorDefinitions),this.currentUILineColorDefinitions?.dataset&&this.handleNewLineColor(t?i:this.currentUILineColorDefinitions)}catch(s){this.$emit("error",""+s)}},async loadGMNSFeatures(e){const t=`${this.subfolder}/${e}`,i=await this.fileApi.getFileBlob(t),s=await j.load(t,i);return j.toGeojson(s).features},async loadAvroNetwork(e){const t=await this.myDataManager.getRoadNetwork(e,this.subfolder,this.vizDetails,null,!0),i=t.linkId.length,s=[];for(let a=0;a<i;a++){const o=t.linkId[a],r=[t.source.slice(a*2,a*2+2),t.dest.slice(a*2,a*2+2)],n={id:o,type:"Feature",properties:{},geometry:{type:"LineString",coordinates:r}};s.push(n)}return this.avroNetwork=t,this.isAvroFile=!0,s},updateStatus(e){this.statusText=e,this.incrementLoadProgress()},async loadXMLNetwork(e){if(!this.myDataManager)throw Error("no datamanager");this.statusText="Loading XML network...";const t=[];try{const i=await this.myDataManager.getRoadNetwork(e,this.subfolder,this.vizDetails,this.updateStatus),s=i.linkId.length,a=i.crs||"EPSG:4326",o=a!=="EPSG:4326"&&a!=="WGS84";this.isAtlantis=!!i.isAtlantis;for(let r=0;r<s;r++){const n=i.linkId[r],l=2*i.from[r],h=2*i.to[r];let d=[i.nodeCoordinates[l],i.nodeCoordinates[1+l]],c=[i.nodeCoordinates[h],i.nodeCoordinates[1+h]];o&&(d=F.toLngLat(a,d),c=F.toLngLat(a,c));const u={id:n,type:"Feature",properties:{},geometry:{type:"LineString",coordinates:[d,c]}};t.push(u)}this.avroNetwork=i,this.isAvroFile=!0}catch(i){this.$emit("error",""+i)}finally{return t}},async loadGeoPackage(e){this.statusText="Loading geopackage...",console.log("loading",e);const t=`${this.subfolder}/${e}`,s=await(await this.fileApi.getFileBlob(t)).arrayBuffer();return _.loadGeoPackageFromBuffer(s)},async loadBoundaries(){const e=this.config.boundaries||this.config.shapes||this.config.geojson||this.config.network||this.config.features;if(!e)return;let t=this.config.features?"shapes":e.file||e,i=[],s;try{if(this.statusText="Loading features...",this.incrementLoadProgress(),t.toLocaleLowerCase().endsWith("gpkg"))console.log("--GPKG"),s=await this.loadGeoPackage(t);else if(t.startsWith("http")){console.log("--HTTP to JSON file");const l=await(await fetch(t).then(async d=>await d.blob())).arrayBuffer().then(d=>q(d)),h=new TextDecoder().decode(l);s=JSON.parse(h).features}else t.toLocaleLowerCase().endsWith(".shp")?(console.log("--SHP"),s=await this.loadShapefileFeatures(t)):t.toLocaleLowerCase().indexOf(".gmns")>-1?(console.log("--GMNS"),s=await this.loadGMNSFeatures(t)):t.toLocaleLowerCase().indexOf(".xml")>-1?(console.log("--MATSIM XML"),s=await this.loadXMLNetwork(t)):/network.*\.avro$/.test(t.toLocaleLowerCase())?(console.log("--AVRO"),s=await this.loadAvroNetwork(t)):this.config.features?(console.log("--DATAFRAME"),s=this.config.features):(console.log("--GEOJSON"),s=(await this.fileApi.getFileJson(`${this.subfolder}/${t}`)).features);await this.$nextTick(),this.statusText="Processing data...",this.incrementLoadProgress(),await this.$nextTick(),await this.$nextTick();let a=!0,o=!0,r=!1;s.forEach(n=>{const l=n.properties??{};"id"in n&&(l.id=n.id),i.push({...l}),n.properties={},(n.geometry.type=="Point"||n.geometry.type=="MultiPoint")&&(r=!0),a&&(n.geometry.type=="LineString"||n.geometry.type=="MultiLineString")&&(a=!1),o&&(n.geometry.type=="Polygon"||n.geometry.type=="MultiPolygon")&&(o=!1)}),await this.setFeaturePropertiesAsDataSource(t,[...i],e),this.incrementLoadProgress(),(r||!o)&&(this.isAreaMode=!0),this.statusText="Adding boundaries to map",await this.$nextTick(),this.incrementLoadProgress(),this.boundaries=s,this.incrementLoadProgress()}catch(a){const n=`${a.statusText||"Could not load"}: "${t}"`;throw this.statusText="",this.$emit("isLoaded"),Error(n)}if(!this.boundaries||this.boundaries.length===0)throw Error('No "features" found in shapes file')},async setFeaturePropertiesAsDataSource(e,t,i){let s;if(this.avroNetwork){const o={},r=[...this.avroNetwork.linkAttributes,"from","to"];r.sort();for(const n of r){const l=this.avroNetwork[n],h=Number.isFinite(l[0])||Number.isNaN(l[0])?D.NUMBER:D.STRING,d={name:n,values:l,type:h};o[n]=d}if(this.avroNetwork.allowedModes){const n=this.avroNetwork.modes,l=o.allowedModes;l.type=D.STRING,l.values=l.values.map(h=>n[h]),o.modes=l,delete o.allowedModes}s=await this.myDataManager.setRowWisePropertyTable(e,o,i),"linkId"in s&&!("id"in s)&&(s={id:s.linkId,...s},s.id.name="id"),this.avroNetwork=null}else s=await this.myDataManager.setFeatureProperties(e,t,i);this.boundaryDataTable=s;const a=e.substring(1+e.lastIndexOf("/"));this.datasets[a]=s,this.vizDetails.datasets[a]={file:a,join:this.datasetJoinColumn},this.config.datasets=Object.assign({},this.vizDetails.datasets),(!this.vizDetails.tooltip||!this.vizDetails.tooltip.length)&&(this.tooltipDesiredColumns=this.setupTooltipDesiredColumns())},async calculateAndMoveToCenter(){let e=0,t=0,i=0;const s=this.boundaries.length;for(let r=0;r<s;r+=256)try{const n=T(this.boundaries[r]);n?.geometry?.coordinates&&(e+=n.geometry.coordinates[0],t+=n.geometry.coordinates[1],i+=1)}catch{}e/=i,t/=i;let a=9;console.log("--- CALCULATED CENTER",e,t),(e==null||t==null)&&(e=30,t=30,a=5);const o={center:[e,t],bearing:0,pitch:0,zoom:a};this.initialView=o,this.vizDetails.mapIsIndependent||this.$store.commit("setMapCamera",o)},async generateCentroidsAndMapCenter(){this.statusText="Calculating centroids...",await this.$nextTick();const e=this.config?.shapes?.join||"id";let t=0,i=0,s=0;for(const a of this.boundaries){let o={};try{o=T(a)}catch{console.warn("no coordinates:"),console.warn(a);continue}o.properties||(o.properties={}),a.properties[this.config.boundariesLabel]&&(o.properties.label=a.properties[this.config.boundariesLabel]),o.properties.id=a.properties[e],o.properties.id===void 0&&(o.properties.id=a[e]),this.centroids.push(o),o.geometry&&(t+=o.geometry.coordinates[0],i+=o.geometry.coordinates[1],s++)}t/=s,i/=s,console.log("CENTER",t,i),this.needsInitialMapExtent&&!this.vizDetails.center&&(this.$store.commit("setMapCamera",{center:[t,i],bearing:0,pitch:0,zoom:9,initial:!0}),this.needsInitialMapExtent=!1)},async loadShapefileFeatures(e){this.statusText="Loading shapefile...",console.log("loading",e);const t=`${this.subfolder}/${e}`;let i,s,a,o={};try{i=await this.fileApi.getFileBlob(t)}catch{return this.$emit("error","Error loading "+t),[]}try{let c=t;c.endsWith(".shp")&&(c=c.slice(0,-4)+".dbf"),c.endsWith(".SHP")&&(c=c.slice(0,-4)+".DBF"),c.endsWith(".Shp")&&(c=c.slice(0,-4)+".Dbf"),s=await this.fileApi.getFileBlob(c),a=await(await s)?.arrayBuffer()}catch{}try{const c=await(await i)?.arrayBuffer();if(!c)return[];this.statusText="Generating shapes...",o=await W(c,a),o.features=o.features.filter(g=>!!g.geometry),this.statusText=""}catch(c){return console.error(c),this.$emit("error",`Error loading shapefile ${t}`),[]}let r=J,n=t;n.endsWith(".shp")&&(n=n.slice(0,-4)+".prj"),n.endsWith(".SHP")&&(n=n.slice(0,-4)+".PRJ"),n.endsWith(".Shp")&&(n=n.slice(0,-4)+".Prj");try{r=await this.fileApi.getFileText(n)}catch(c){console.error(""+c)}const l=this.vizDetails.projection||F.guessProjection(r);l&&(this.statusText="Projecting coordinates...",await this.$nextTick(),o=R.toWgs84(o,l,F.allEPSGs),this.statusText="");function h(c){return Array.isArray(c[0])?h(c[0]):[c[0],c[1]]}const d=h(o.features[0].geometry.coordinates);return Math.abs(d[0])>180||Math.abs(d[1])>90?(this.$emit("error","Coordinates not lon/lat. Try adding projection to YAML, or provide a .prj file"),this.statusText="",[]):o.features},async loadDatasets(){const e=Object.keys(this.vizDetails.datasets);e.length>1&&(this.featureJoinColumn=await this.figureOutFeatureIdColumn());for(const t of e)t in this.datasets||await this.loadDataset(t);if(this.config.xferdata){for(const t in this.config.xferdata){console.log("XFERDATA --"+t);const i={};for(const s in this.config.xferdata[t]){const a=this.config.xferdata[t][s],o=Number.isFinite(a[0])?D.NUMBER:D.STRING;i[s]={name:s,type:o,values:a}}this.myDataManager.setPreloadedDataset({key:t,dataTable:i}),this.datasets[t]=i,this.myDataManager.addFilterListener({dataset:t,subfolder:this.subfolder},this.processFiltersNow)}delete this.config.xferdata,this.featureJoinColumn=this.config.geojson.join}},async loadDataset(e){try{if(!e)return;const t=typeof this.config.datasets[e]=="string"?this.config.datasets[e]:this.config.datasets[e].file;this.statusText=`Loading dataset ${t} ...`,await this.$nextTick();let i={dataset:t};typeof this.config.datasets[e]!="string"&&(i=Object.assign(i,this.config.datasets[e])),this.datasetKeyToFilename[e]=t;const s=await this.myDataManager.getDataset(i,{subfolder:this.subfolder}),a=Object.keys(s.allRows)[0],r=(typeof this.config.datasets[e]=="string"?a:this.config.datasets[e].join||a)?.split(":")||[];r.length==2&&(this.featureJoinColumn=r[0]),r.length==1&&r.push(r[0]),this.datasets[e]=s.allRows,await this.$nextTick(),this.myDataManager.addFilterListener({dataset:t,subfolder:this.subfolder},this.processFiltersNow),this.activateFiltersForDataset(e)}catch(t){const i=""+t;console.error(i),this.$emit("error",i)}return[]},async activateFiltersForDataset(e){const t=this.filterDefinitions.filter(i=>i.dataset===e);for(const i of t)if(i.value=="@categorical")this.filters[i.column]?i.value=this.filters[i.column].active:this.handleUserCreatedNewFilter(`${e}:${i.column}`);else try{await this.myDataManager.setFilter(Object.assign(i,{dataset:this.datasetKeyToFilename[e]}))}catch(s){this.$emit("error",`Filter ${e}.${i.column}: `+s)}},filterLabel(e){let t=this.filters[e].active.join(",").substring(0,50)||"Select...";return t.length===50&&(t+="..."),t},async handleUserSelectedNewMetric(){await this.$nextTick(),console.log("METRIC",this.datasetValuesColumn);const e=Object.assign({},this.$route.query);e.display=this.datasetValuesColumn,this.$router.replace({query:e}),this.maxValue=this.boundaryDataTable[this.datasetValuesColumn].max||0,this.vizDetails.display.fill.columnName=this.datasetValuesColumn,this.vizDetails=Object.assign({},this.vizDetails),this.processFiltersNow()},handleUserSelectedNewFilters(e){const t=this.filters[e],i=t.active;this.myDataManager.setFilter({dataset:this.datasetKeyToFilename[t.dataset],column:e,invert:!1,value:i});const s=Object.assign({},this.$route.query);for(const a of Object.entries(this.filters))a[1].active.length?s[a[0]]=a[1].active.join(","):delete s[a[0]];JSON.stringify(this.$route.query)!==JSON.stringify(s)&&this.$router.replace({query:s})},showCircles(e){this.useCircles=e;const t=Object.assign({},this.$route.query);e?t.show="dots":delete t.show,this.$router.replace({query:t})},handleUserCreatedNewFilter(e){const t=e||this.chosenNewFilterColumn,[i,s]=t.split(":");let a=[...new Set(this.datasets[i][s].values)];if(this.chosenNewFilterColumn="",a.length>48){alert(`Column ${s} has too many values to be used as a filter.`);return}this.filters[s]={column:s,label:s,options:a,active:[],dataset:i}},clearData(){this.boundaries=[],this.centroids=[],this.boundaryDataTable={},this.boundaryFilters=new Float32Array(0),this.datasets={},this.dataFillColors="#888",this.dataLineColors="",this.dataLineWidths=1,this.dataPointRadii=5,this.dataFillHeights=0,this.dataCalculatedValues=null,this.dataCalculatedValueLabel="",this.bgLayers={},this.cbDatasetJoined=null,this.dataNormalizedValues=null,this.resizer=null,this.myDataManager.clearCache()},updateBgLayers(){this.bgLayers={...this.bgLayers}}},async mounted(){try{if(this.dbClearTooltip=H(this.clearTooltip,1e3),this.setEmbeddedMode(),this.clearData(),await this.getVizDetails(),this.vizDetails.center&&typeof this.vizDetails.center=="string"&&(this.vizDetails.center=this.vizDetails.center.split(",").map(e=>parseFloat(e)),this.config.center=this.config.center.split(",").map(e=>parseFloat(e))),this.config.center&&(Math.abs(this.config.center[0])>180||Math.abs(this.config.center[1])>90)){this.$emit("error",`Invalid map center, doesn't look like longitude/latitude: ${this.config.center}`);const e=this.globalState.viewState;this.vizDetails.center=[e.longitude,e.latitude],this.config.center=[e.longitude,e.latitude],this.vizDetails.zoom=e.zoom,this.config.zoom=e.zoom}if(this.buildOldJoinLookups(),this.filterDefinitions=this.parseFilterDefinitions(this.vizDetails.filters),this.needsInitialMapExtent&&this.vizDetails.center){this.needsInitialMapExtent=!1;const e={center:this.vizDetails.center,zoom:this.vizDetails.zoom||9,bearing:this.vizDetails.bearing||0,pitch:this.vizDetails.pitch||0,initial:!0};this.vizDetails.mapIsIndependent?this.initialView=e:this.$store.commit("setMapCamera",e)}this.expColors=this.config.display?.fill?.exponentColors,this.dataFillColors=L.state.isDarkMode?"#44445580":"#dddddd80",this.config.display.fill||(this.config.display.fill={}),this.config.display?.fill?.values&&(this.config.display.fill.values=this.convertCommasToArray(this.config.display.fill.values)),await this.loadBoundaries(),this.filterShapesNow(),this.needsInitialMapExtent&&!this.vizDetails.center&&(await this.calculateAndMoveToCenter(),this.needsInitialMapExtent=!1),this.isLoaded=!0,this.$emit("isLoaded"),await this.$nextTick(),await this.loadDatasets(),this.datasets=Object.assign({},this.datasets),this.vizDetails=Object.assign({},this.vizDetails),this.honorQueryParameters(),this.backgroundLayers=new z({vizDetails:this.vizDetails,fileApi:this.fileApi,subfolder:this.subfolder}),await this.backgroundLayers.initialLoad()}catch(e){this.$emit("error",""+e),this.$emit("isLoaded")}this.statusText=""},beforeDestroy(){this.clearData(),this.legendStore.clear(),this.resizer?.disconnect(),this.myDataManager.removeFilterListener(this.config,this.processFiltersNow),this.$store.commit("setFullScreen",!1)}});var ct=function(){var t=this,i=t._self._c;return t._self._setupProxy,i("div",{staticClass:"shapefile-viewer",attrs:{oncontextmenu:"return false"}},[t.showJoiner?i("modal-id-column-picker",t._b({attrs:{header:"Which column contains the unique ID for each shape/feature?"},on:{join:t.cbDatasetJoined}},"modal-id-column-picker",t.datasetJoinSelector,!1)):t._e(),t.statusText?i("div",{staticClass:"status-box"},[i("p",[t._v(t._s(t.statusText))]),t.loadProgress>0?i("b-progress",{staticClass:"load-progress",attrs:{value:t.loadProgress,rounded:!1,type:"is-success"}}):t._e()],1):t._e(),i("div",{staticClass:"main-layout",on:{mousemove:t.dividerDragging}},[i("div",{directives:[{name:"show",rawName:"v-show",value:t.showLegend,expression:"showLegend"}],staticClass:"dragger",on:{mousedown:t.dividerDragStart,mouseup:t.dividerDragEnd,mousemove:function(s){return s.stopPropagation(),t.dividerDragging.apply(null,arguments)}}}),i("div",{directives:[{name:"show",rawName:"v-show",value:t.showLegend,expression:"showLegend"}],staticClass:"new-rightside-info-panel",style:{width:`${t.legendSectionWidth}px`}},[i("div",{staticClass:"legend-panel scrolly"},[t.legendStore.state?.sections?.length?t._e():i("p",{staticStyle:{"font-size":"1.1rem"}},[i("b",[t._v("INFO PANEL")])]),i("legend-box",{attrs:{legendStore:t.legendStore}}),Object.keys(t.bgLayers).length?i("div",{staticClass:"bglayer-section flex-col"},[i("h5",[t._v("Layers")]),t._l(Object.keys(t.bgLayers),function(s){return i("b-checkbox",{key:s,staticClass:"simple-checkbox",on:{input:t.updateBgLayers},model:{value:t.bgLayers[s].visible,callback:function(a){t.$set(t.bgLayers[s],"visible",a)},expression:"bgLayers[layer].visible"}},[t._v(t._s(s))])})],2):t._e()],1),t.tooltipHtml&&!t.statusText?i("div",{staticClass:"tooltip-html flex-col",on:{mouseover:function(s){t.wantToClearTooltip=!1},mouseout:function(s){t.wantToClearTooltip=!0}}},[i("div",{staticClass:"the-html",domProps:{innerHTML:t._s(t.tooltipHtml)}}),t.tooltipDesiredColumns.length?i("div",{staticClass:"edit-hint",staticStyle:{"text-align":"right"}},[i("a",{on:{click:function(s){t.showTooltipConfigurator=!0}}},[t._v("Show/hide...")])]):t._e()]):t._e()]),i("div",{staticClass:"area-map",attrs:{id:`container-${t.layerId}`}},[!t.showLegend&&!t.statusText&&t.tooltipHtml?i("div",{staticClass:"tooltip-when-no-legend-present flex-col",on:{mouseover:function(s){t.wantToClearTooltip=!1},mouseout:function(s){t.wantToClearTooltip=!0}}},[i("div",{staticClass:"the-html",domProps:{innerHTML:t._s(t.tooltipHtml)}}),t.tooltipDesiredColumns.length?i("a",{staticStyle:{textAlign:"right"},on:{click:function(s){t.showTooltipConfigurator=!0}}},[t._v("Show/hide...")]):t._e()]):t._e(),t.needsInitialMapExtent?t._e():i("geojson-layer",{staticClass:"map-layers",attrs:{bgLayers:t.backgroundLayers,cbTooltip:t.cbTooltip,cbClickEvent:t.handleClickEvent,dark:t.globalState.isDarkMode,features:t.boundaries,featureFilter:t.boundaryFilters,fillColors:t.dataFillColors,fillHeights:t.dataFillHeights,highlightedLinkIndex:t.highlightedLinkIndex,initialView:t.initialView,isRGBA:t.isRGBA,isAtlantis:t.isAtlantis,lineColors:t.dataLineColors,lineWidths:t.dataLineWidths,mapIsIndependent:!!t.vizDetails.mapIsIndependent,opacity:t.sliderOpacity/100*(t.sliderOpacity/100),pointRadii:t.dataPointRadii,redraw:t.redraw,screenshot:t.triggerScreenshot,viewId:t.layerId}}),t.showTooltipConfigurator?i("div",{staticClass:"modal modal-tooltip-picker flex-col",on:{mouseover:function(s){t.wantToClearTooltip=!1}}},[i("h4",[t._v("Configure tooltips")]),i("p",{staticStyle:{margin:"0.5rem auto 0 0.75rem"}},[t._v("Select feature columns to be displayed in default tooltips.")]),i("div",{staticClass:"flex-row",staticStyle:{margin:"0.25rem auto 0 0.75rem",gap:"0.25rem"}},[i("b-button",{staticClass:"is-small",attrs:{type:"is-link",outlined:""},on:{click:t.setDesiredTooltipsNone}},[t._v("None")]),i("b-button",{staticClass:"is-small",attrs:{type:"is-link",outlined:""},on:{click:t.setDesiredTooltipsAll}},[t._v(" All ")])],1),i("div",{staticClass:"tooltip-items flex-col flex1"},t._l(t.tooltipDesiredColumns,function(s,a){return i("b-checkbox",{key:s.col,staticClass:"cbspace",model:{value:s.enabled,callback:function(o){t.$set(s,"enabled",o)},expression:"item.enabled"}},[t._v(" "+t._s(s.col))])}),1),i("div",{staticClass:"close-row flex-row",staticStyle:{padding:"0.5rem","margin-left":"auto",gap:"0.25rem"}},[i("b-button",{staticClass:"is-small",attrs:{type:"is-success"},on:{click:function(s){t.showTooltipConfigurator=!1}}},[t._v(" Close ")])],1)]):t._e(),t.isLoaded?i("viz-configurator",{attrs:{embedded:t.isEmbedded,sections:t.configuratorSections,fileSystem:t.fileSystem,subfolder:t.subfolder,yamlConfig:t.generatedExportFilename,vizDetails:t.vizDetails,datasets:t.datasets,legendStore:t.legendStore,filterDefinitions:t.currentUIFilterDefinitions},on:{update:t.changeConfiguration,screenshot:t.takeScreenshot,toggleLegend:function(s){t.showLegend=!t.showLegend}}}):t._e(),t.isAreaMode?i("div",{staticClass:"width-sliders flex-row",style:{backgroundColor:t.globalState.isDarkMode?"#00000099":"#ffffffaa"}},[i("img",{staticClass:"icon-blue-ramp",attrs:{src:t.icons.blueramp}}),i("b-slider",{staticClass:"pie-slider",attrs:{type:"is-success",tooltip:!0,size:"is-small",min:0,max:100},model:{value:t.sliderOpacity,callback:function(s){t.sliderOpacity=s},expression:"sliderOpacity"}})],1):t._e(),t.isLoaded&&!t.vizDetails.mapIsIndependent?i("zoom-buttons"):t._e(),!t.isEmbedded&&t.isLoaded&&Object.keys(t.filters).length?i("div",{staticClass:"config-bar",class:{"is-standalone":!t.configFromDashboard,"is-disabled":!t.isLoaded}}):t._e(),t._l(Object.keys(t.filters),function(s){return i("div",{staticClass:"filter"},[i("p",[t._v(t._s(s))]),i("b-dropdown",{attrs:{scrollable:t.filters[s].active.length>10,"max-height":"250",multiple:"","aria-role":"list","mobile-modal":!1,"close-on-click":!0},on:{change:function(a){return t.handleUserSelectedNewFilters(s)}},scopedSlots:t._u([{key:"trigger",fn:function({active:a}){return[i("b-button",{staticClass:"is-primary",attrs:{type:t.filters[s].active.length?"":"is-outlined",label:t.filterLabel(s)}})]}}],null,!0),model:{value:t.filters[s].active,callback:function(a){t.$set(t.filters[s],"active",a)},expression:"filters[filter].active"}},t._l(t.filters[s].options,function(a){return i("b-dropdown-item",{key:a,attrs:{value:a,"aria-role":"listitem"}},[t._v(t._s(a))])}),1)],1)})],2)])],1)},ht=[],ut=P(dt,ct,ht,!1,null,"f591713f");const Yt=ut.exports;export{Yt as default};
