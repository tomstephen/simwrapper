import{d as m,g as h,m as f,n as b}from"./index-DwHrM92q.js";import{O as d,L as C}from"./LineOffsetLayer-BT_eFkEQ.js";import{G as k,S as x}from"./GeojsonOffsetLayer-Bnd_y6YX.js";import{M as v}from"./mapbox-overlay-HS93bZkL.js";import{D as u}from"./data-filter-extension-BJBYmUft.js";import{L}from"./line-layer-BJTc6V-8.js";import{r as p}from"./cubehelix-BzW-tINw.js";const c="/simwrapper/",S=m({name:"GeojsonDeckComponent",props:{features:{type:Array},bgLayers:{type:Object},cbTooltip:{type:Function,required:!0},cbClickEvent:{type:Function,required:!0},dark:{type:Boolean,required:!0},featureFilter:{type:Float32Array,required:!0},fillColors:{type:[String,Uint8ClampedArray],required:!0},fillHeights:{type:[Number,Float32Array],required:!0},highlightedLinkIndex:{type:Number},initialView:{type:Object},isRGBA:{type:Boolean,required:!0},isAtlantis:{type:Boolean,required:!0},lineColors:{type:[String,Uint8ClampedArray]},lineWidths:{type:[Number,Float32Array],required:!0},mapIsIndependent:{type:Boolean,required:!0},opacity:{type:Number,required:!0},pointRadii:{type:[Number,Float32Array],required:!0},redraw:{type:Number,required:!0},screenshot:{type:Number,required:!0},viewId:{type:Number,required:!0}},data(){return{mymap:null,deckOverlay:null,globalState:h.state,screenshotCount:this.screenshot,tooltipHTML:"",tooltipStyle:{position:"absolute",padding:"4px 8px",display:"block",top:0,left:0,color:this.dark?"#ccc":"#223",backgroundColor:this.dark?"#2a3c4f":"white",zIndex:2e4}}},watch:{screenshot(){this.mymap&&this.deckOverlay&&x.saveMapWithOverlay(this.mymap)},layers(){this.deckOverlay&&this.deckOverlay.setProps({layers:this.layers})},dark(){let e;this.hasBackgroundMap?e=`${c}map-styles/${this.globalState.isDarkMode?"dark":"positron"}.json`:e={version:8,sources:{},layers:[]},this.mymap?.setStyle(e)},"globalState.viewState"(){if(this.mapIsIndependent)return;const e=this.globalState.viewState,t=this.mymap?.getCenter();if(e.longitude!==t.lng||e.latitude!==t.lat||e.zoom!==this.mymap?.getZoom()||e.pitch!==this.mymap?.getPitch()||e.bearing!==this.mymap?.getBearing()){const i=Object.assign({center:{lng:e.longitude,lat:e.latitude}},e);this.mymap?.jumpTo(i)}}},computed:{isTakingScreenshot(){return this.screenshot>this.screenshotCount},isStroked(){return!!this.lineColors&&this.lineWidths!==0},hasBackgroundMap(){return!this.isAtlantis},cbFillColor(){let e;if(typeof this.fillColors=="string"){const t=p(this.fillColors);e=[t.r,t.g,t.b]}else e=(t,i)=>this.isRGBA?[this.fillColors[i.index*4+0],this.fillColors[i.index*4+1],this.fillColors[i.index*4+2],this.fillColors[i.index*4+3]]:[this.fillColors[i.index*3+0],this.fillColors[i.index*3+1],this.fillColors[i.index*3+2],255];return e},cbLineColor(){let e;if(typeof this.lineColors=="string"){const t=p(this.lineColors);e=[t.r,t.g,t.b],this.isStroked||e.push(0)}else e=(t,i)=>i?.index?this.lineColors?[this.lineColors[i.index*3+0],this.lineColors[i.index*3+1],this.lineColors[i.index*3+2],255]:[0,0,0,0]:[0,0,0,0];return e},cbLineWidth(){let e;return typeof this.lineWidths=="number"?e=this.lineWidths:e=(t,i)=>this.lineWidths[i.index],e},cbPointRadius(){let e;return typeof this.pointRadii=="number"?e=this.pointRadii:e=(t,i)=>this.pointRadii[i.index],e},cbFillHeight(){let e;return typeof this.fillHeights=="number"?e=this.fillHeights:e=(t,i)=>this.fillHeights[i.index],e},lineLayers(){if(!this.isStroked)return{linksData:[],hasPolygons:!0};const e=[];let t=!1;const i=[];return(this.features||[]).forEach((s,r)=>{let o;switch(s.geometry.type){case"Polygon":o=s.geometry.coordinates[0],t=!0;break;case"MultiPolygon":o=s.geometry.coordinates[0][0],t=!0;break;case"LineString":o=s.geometry.coordinates;break;case"MultiLineString":o=s.geometry.coordinates[0];break;case"Point":case"MultiPoint":default:return t=!0,{linksData:[],hasPolygons:t}}if(!o)return console.warn(`---Feature ${r+1} has no coordinates:`),console.warn(s),{linksData:[],hasPolygons:t};const g=!Array.isArray(this.cbLineColor),y=typeof this.cbLineWidth!="number";for(let l=1;l<o.length;l++){const a={path:[o[l-1],o[l]]};g&&(a.color=this.cbLineColor(null,{index:r})),y&&(a.width=this.cbLineWidth(null,{index:r})),a.feature_idx=r,this.featureFilter.length&&i.push(this.featureFilter[r]),e.push(a)}}),{linksData:e,hasPolygons:t,filterValues:i}},layers(){const e=[],t=this.bgLayers?.layers();if(t&&e.push(...t.layersBelow),this.lineLayers.hasPolygons&&e.push(new k({id:"geoJsonOffsetLayer",beforeId:"water",data:this.features,getLineWidth:this.cbLineWidth,getLineColor:this.cbLineColor,getFillColor:this.cbFillColor,getPointRadius:this.cbPointRadius,getElevation:this.cbFillHeight,extruded:!!this.fillHeights,highlightedObjectIndex:this.highlightedLinkIndex==-1?null:this.highlightedLinkIndex,autoHighlight:!0,highlightColor:[255,255,255,160],lineWidthUnits:"pixels",lineWidthScale:1,lineWidthMinPixels:0,lineWidthMaxPixels:50,getOffset:d.RIGHT,opacity:this.opacity,pickable:!0,pointRadiusUnits:"pixels",pointRadiusMinPixels:2,stroked:this.isStroked,updateTriggers:{getFillColor:this.fillColors,getLineColor:this.lineColors,getLineWidth:this.lineWidths,getPointRadius:this.pointRadii,getElevation:this.fillHeights,getFilterValue:this.featureFilter},transitions:{getFillColor:300,getLineColor:300,getLineWidth:300,getPointRadius:300},parameters:{depthTest:!!this.fillHeights,fp64:!1},extensions:[new u({filterSize:1})],filterRange:[0,1],getFilterValue:(i,n)=>this.featureFilter[n.index]})),this.isStroked){const i=this.lineLayers.filterValues||this.featureFilter,n=typeof this.cbLineWidth=="number"?L:C,s=Array.isArray(this.cbLineColor)?this.cbLineColor:r=>r.color;e.push(new n({id:"linksLayer",data:this.lineLayers.linksData,getColor:s,getWidth:typeof this.cbLineWidth=="number"?this.cbLineWidth:r=>r.width,getSourcePosition:r=>r.path[0],getTargetPosition:r=>r.path[1],pickable:!0,autoHighlight:!0,highlightedObjectIndex:this.highlightedLinkIndex==-1?null:this.highlightedLinkIndex,highlightColor:[255,255,255,160],opacity:1,widthUnits:"pixels",widthMinPixels:1,offsetDirection:d.RIGHT,transitions:{getColor:300,getWidth:300},parameters:{depthTest:!!this.fillHeights,fp64:!1},extensions:[new u({filterSize:1})],filterRange:[0,1],getFilterValue:(r,o)=>i[o.index]}))}return t&&e.push(...t.layersOnTop),e}},mounted(){let e;this.hasBackgroundMap?e=`${c}map-styles/${this.globalState.isDarkMode?"dark":"positron"}.json`:e={version:8,sources:{},layers:[]};const t=`map-${this.viewId}`,i=this.globalState.viewState.center,n=this.globalState.viewState.zoom;this.mymap=new f.Map({container:t,style:e,center:i,zoom:n,canvasContextAttributes:{preserveDrawingBuffer:!0}}),this.mymap.on("move",this.handleMove),this.mymap.on("style.load",()=>{this.deckOverlay=new v({interleaved:!0,layers:this.layers,onClick:this.handleClick,onHover:this.handleHover,onDrag:this.handleHover,pickingRadius:2,getCursor:s=>s.isHovering?"pointer":"grab"}),this.mymap?.addControl(this.deckOverlay)})},beforeDestroy(){this.deckOverlay&&this.mymap?.removeControl(this.deckOverlay),this.mymap?.remove(),this.mymap=null},methods:{handleMove(){if(this.mapIsIndependent)return;const e=this.mymap?.getCenter(),t={center:[e.lng,e.lat],zoom:this.mymap?.getZoom(),bearing:this.mymap?.getBearing(),pitch:this.mymap?.getPitch(),jump:!0};h.commit("setMapCamera",t)},getTooltip({object:e,index:t}){let i=t;e&&"feature_idx"in e&&(i=e.feature_idx),this.cbTooltip&&this.cbTooltip(i,e)},handleClick(e,t){this.cbClickEvent&&this.cbClickEvent(e)},handleHover(e,t){if(e.index==-1){this.cbTooltip(-1,null);return}this.getTooltip(e)}}});var w=function(){var t=this,i=t._self._c;return t._self._setupProxy,i("div",{staticClass:"deck-map flex-col"},[i("div",{staticClass:"map-container",attrs:{id:`map-${t.viewId}`}})])},F=[],W=b(S,w,F,!1,null,null);const D=W.exports;export{D};
